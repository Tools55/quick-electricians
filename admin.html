<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Quick Electrician</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary-color:#007BFF;--secondary-color:#28a745;--danger-color:#dc3545;--warning-color:#ffc107;--info-color:#17a2b8;--dark-color:#343a40;--light-color:#f8f9fa}
        body{font-family:'Poppins',sans-serif;background-color:var(--light-color);color:var(--dark-color);margin:0}
        .container{max-width:1200px;margin:2rem auto;padding:0 20px}
        header{background:var(--dark-color);color:white;padding:1rem 0;text-align:center;margin-bottom:2rem}
        .tabs{display:flex;flex-wrap:wrap;border-bottom:2px solid #dee2e6;margin-bottom:2rem}
        .tab-link{padding:.8rem 1rem;cursor:pointer;border:none;background:none;font-size:1rem;font-weight:600;color:#495057}
        .tab-link.active{color:var(--primary-color);border-bottom:3px solid var(--primary-color)}
        .tab-content{display:none}.tab-content.active{display:block}
        .card{background:white;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1);margin-bottom:2rem;overflow:hidden}
        .card-header{background:var(--primary-color);color:white;padding:1rem;font-size:1.2rem;font-weight:600}
        .card-body{padding:1.5rem}
        .item-list{max-height:80vh;overflow-y:auto}
        .list-item{padding:1rem;border-bottom:1px solid #eee}.list-item:last-child{border:none}
        .item-details p{margin:.2rem 0;word-break:break-all}.item-details strong{color:#555}
        .item-actions{margin-top:1rem}
        .btn{padding:.5rem 1rem;border:none;border-radius:5px;color:white;cursor:pointer;margin-right:10px}
        .btn-approve{background:var(--secondary-color)}
        .btn-complete{background:var(--info-color)}
        .btn-reject{background:var(--danger-color)}
        .status-tag{padding:.25rem .6rem;border-radius:15px;color:white;font-size:.8rem;font-weight:600;display:inline-block;margin-left:10px}
        .status-Pending{background:var(--warning-color);color:var(--dark-color)}
        .status-Confirmed{background:var(--info-color)}
        .status-Completed{background:var(--secondary-color)}
        .status-Cancelled{background:var(--danger-color)}
        .loader{text-align:center;padding:2rem;font-size:1.2rem;}
    </style>
</head>
<body>
    <header><h1>Quick Electrician - Admin Panel</h1></header>
    <div class="container">
        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'WorkBookings')">Work Bookings</button>
            <button class="tab-link" onclick="openTab(event, 'AllElectricians')">All Electricians</button>
        </div>
        <div id="WorkBookings" class="tab-content active">
            <div class="card"><div class="card-header">Manage Customer Bookings</div><div class="card-body"><div class="item-list" id="booking-list"></div></div></div>
        </div>
        <div id="AllElectricians" class="tab-content">
            <div class="card"><div class="card-header">Registered Electricians List</div><div class="card-body"><div class="item-list" id="all-electricians-list"></div></div></div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://pdsdxcecqzefupnoifef.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkc2R4Y2VjcXplZnVwbm9pZmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MjYyNzksImV4cCI6MjA2NTQwMjI3OX0.udrBz6JtnqaYfHJusxINv1BWS-_HI5tf8F2FhMmb6Co';
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function openTab(e,t){
            document.querySelectorAll(".tab-content").forEach(e=>e.style.display="none");
            document.querySelectorAll(".tab-link").forEach(e=>e.classList.remove("active"));
            document.getElementById(t).style.display="block";
            e.currentTarget.classList.add("active");
        }
        
        async function fetchAllElectricians(){
            const list=document.getElementById('all-electricians-list');
            list.innerHTML=`<div class="loader">Loading...</div>`;
            const {data,error}=await db.from('electricians').select().order('created_at',{ascending:!1});
            if(error || !data || data.length === 0){list.innerHTML=`<p>No electricians found.</p>`;return}
            list.innerHTML=data.map(e=>`<div class="list-item"><p><strong>${e.name}</strong> (${e.phone}) - <strong>Status:</strong> ${e.is_verified?"Verified":"Pending"}</p></div>`).join('');
        }
        
        async function fetchBookings(){
            const list=document.getElementById('booking-list');
            list.innerHTML=`<div class="loader">Loading...</div>`;
            const {data,error}=await db.from('bookings').select(`*, electricians(name)`).order('created_at',{ascending:!1});
            if(error || !data || data.length === 0){list.innerHTML=`<p>No bookings found.</p>`;return}
            list.innerHTML = data.map(e => `
                <div class="list-item" id="booking-item-${e.id}">
                    <div class="item-details">
                        <p><strong>Service:</strong> ${e.service} <span class="status-tag status-${e.status}">${e.status}</span></p>
                        <p><strong>Customer:</strong> ${e.name} (${e.phone})</p>
                        <p><strong>Address:</strong> ${e.address}</p>
                        <p><strong>Assigned To:</strong> ${e.electricians ? e.electricians.name : 'Not Assigned'}</p>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-approve" data-id="${e.id}">Approve</button>
                        <button class="btn btn-complete" data-id="${e.id}">Complete</button>
                        <button class="btn btn-reject" data-id="${e.id}">Reject</button>
                    </div>
                </div>`).join('');
        }
        
        document.getElementById('booking-list').addEventListener('click', async e => {
            if (e.target.matches('button')) {
                const id = e.target.dataset.id;
                let newStatus = '';

                if(e.target.classList.contains('btn-approve')) newStatus = 'Confirmed';
                else if(e.target.classList.contains('btn-complete')) newStatus = 'Completed';
                else if(e.target.classList.contains('btn-reject')) newStatus = 'Cancelled';

                if(newStatus){
                    e.target.disabled = true;
                    const {error} = await db.from('bookings').update({ status: newStatus }).eq('id', id);
                    if(error){
                        alert('Failed to update status.');
                        e.target.disabled = false;
                    } else {
                        alert(`Booking status updated to ${newStatus}.`);
                        fetchBookings(); // Refresh the list
                    }
                }
            }
        });

        document.addEventListener('DOMContentLoaded',()=>{
            fetchAllElectricians();
            fetchBookings();
        });
    </script>
</body>
</html>
